# Graham Crackers Solution

- **Author**: [supasuge](https://github.com/supasuge) | Evan Pardon
- **Difficulty**: Hard

## RSA Refresher
Public key = (n, e)
$n = p*q$ where $p$,$q$ are large prime numbers
Encryption:
$ct = m^{e} \mod{n}$
Decryption:
$\phi{(n)}$= $(p-1)\times(q-1)$
$d(\text{private key})$ = $e^{-1} \mod \phi(n)$
$pt = ct^{d} \mod n$
## Overview

The Coppersmith–Howgrave–Graham (CHG) method is a lattice-based technique to find **small roots of univariate polynomial equations modulo a large integer**, often applied in RSA cryptanalysis. Specifically, when the plaintext message $M$ has a known structure, CHG can efficiently recover small unknown portions of $M$.

### Challenge Context

In this challenge, we're provided:
- RSA modulus $N = pq$.
- Public exponent $e$.
- Ciphertext $C \equiv M^e \mod N$.
The plaintext $M$ structured as:


$$M = 2^{\text{length}_N} - 2^{K_{\text{bits}}} + K$$

  where:
- $\text{length}_N$ is the bit-length of $N$.
- $K_{\text{bits}}$ is the bit-length of the unknown integer $K$.
- $K$ encodes the flag.

Given that $K \ll N$, CHG is suitable for finding the integer $K$.

## Mathematical Setup

We define a polynomial based on the structure of $M$:

$$f(x) = (2^{\text{length}_N} - 2^{K_{\text{bits}}} + x)^e - C$$

Our objective is finding a small root $x = K$ modulo $N$, satisfying:

$$f(K) \equiv 0 \mod N$$

## Coppersmith–Howgrave–Graham Method

### Step 1: Polynomial Construction

We use the polynomial constructed above:

$$f(x) = (2^{\text{length}_N} - 2^{K_{\text{bits}}} + x)^e - C$$

### Step 2: Lattice Construction

A lattice basis is created from polynomials:

$$g_{i,j}(x) = (xX)^j N^{m - i} (f(xX))^i$$

where parameters $m$, $t$, and $X$ depend on $\beta$, $\epsilon$, and the polynomial degree $d$.

- $\beta \approx 1$, $X \approx N^{(\beta^2/d)-\epsilon}$
- Optimal parameters for this challenge:

$$m = \lceil \beta^2 / (d \epsilon) \rceil, \quad t = \lfloor d m ((1/\beta)-1) \rfloor$$

### Step 3: LLL Reduction & Root Extraction

We apply the LLL algorithm to the constructed lattice basis. The reduced basis typically reveals a polynomial whose small integer root is our unknown $K$.

## Practical Run

The parameters:

- $N \approx 2^{4097}$
- $e = 3$, $K_{\text{bits}} = 200$

We verified conditions:

$$X^{n-1} < N^{\beta m} \quad \text{(satisfied)}$$

After lattice reduction, the polynomial yields potential roots. Among these:

$$K = 448479597905287366562801337296132819016115865214099082453373$$

We reconstruct $M$:

$$M = 2^{\text{length}_N} - 2^{K_{\text{bits}}} + K$$

Converting $M$ to bytes reveals the flag:

```text
GrizzCTF{Graham_Cracked!}
```

## Code Implementation (solve.sage)

The provided SageMath script:
- Defines the polynomial and parameters.
- Constructs and reduces the lattice via LLL.
- Finds small roots and verifies correctness.
- Decodes and recovers the plaintext (flag).

## Conclusion

This challenge demonstrates the practical application of the CHG method for attacking structured RSA plaintexts. Through careful mathematical formulation, lattice reduction, and small-root finding, we successfully retrieved the flag:

```
GrizzCTF{Graham_Cracked!}
```

#### Sample Run (`solve.sage`)

---

### Mathematical Context

In the Howgrave-Graham variant of Coppersmith's method, we're solving:

$M = 2^{length_N} - 2^{Kbits} + K$ (where K is small)
$C ≡ M^e \pmod{N}$

Therefore:
$C ≡ (2^{length_N} - 2^{Kbits} + K)^e \pmod{N}$

Let's define our polynomial:
$f(x) = (2^{length_N} - 2^{Kbits} + x)^e - C$    

Parameters:
$N$: $1044388881413152506691752710716624382579964249047383780384233483283953907971557456848826811934997558340890106714439262837987573438185793607263236087851365277945956976543709998340361590134383718314428070011855946226376318839397712745672334684344586617496807908705803704071284048740118609114467977783598029006686938976881787785946905630190260940599579453432823469303026696443059025015972399867714215541693835559885291486318237914434496734087811872639496475100189041349008417061675093668333850551032972088269550769983616369411933015213796825837188091833656751221318492846368125550225998300412344784862595674492194617107766087686511607792989085017252143815336613006118525717787806438387060725974265620447965686506814553788073277382250190105705405186375024556833291006823773637983292284527779401216796709835850690521381013583202448370799186156489522196238248039801706889984061598510143551993564543378505292143052178826887278512641781002799084056839536397276217311109569190045037766785935099032805517858354520980090274128587808504179811531037024848206067101247897906212552772476965139547592846335713345792575061160715963452636783429069083092588478551284216547986935684693225387468951564347041644471458189153699117097101912389873234163020901$ ($\text{bit length}$: $4097$)
$e$: $3$
$\text{N bit length}$: $4096$
Kbits: $200$
Coppersmith Parameters:
$d$ (polynomial degree): 3
$m$ (multiplicity): 3
$t$ (extra shifts): 0
X (bound): $7256641442280835233301778621760379063953665817337412353825160297177947071727699350605311339956648916092710036615215403794887510365982603750841130604304303522688162125451161899924467142724040406758072119258324459880769819662659332915638$

Howgrave-Graham's Theorem states that we need:

$$\|p(xX)\| < \frac{N^m}{\sqrt{n}}$$
where $n$ is the lattice dimension    

Checking Howgrave-Graham Conditions:
$X^{n-1} = 7.68927365891604e1878$
$N^{β·m} = 1139165225263043370845938579315932008621298468028614501113799533426642439172469691567306477711637014807943967858591694430860851793602514412750433611928876871974929526595136714292202269877243080587167355589274624927976353262692345148008309507573685819955835876321194702904067672852630585653761861644571242372171305938720329762415531090187952999394484080243158140230933768654317732072862346478657014808167434738566098066865703948435697960690698143820219097883920407003040686456523245108233529281149726862222693477558297365169919254213176849897203892254348439995073129761356765109910020479495393380661515697239302324456675580537861285295416194569300459698969566610100156425585528838582331535664077681027241145212247330414946801077050336275243656949609034332555086117514837847549416366298057634003713008614758167279648281039600485210887498881580387097397659794353266289163016771855001406761430387293426543552011143509912506391232167601835738757144324801120852834935748283761385604417723838169116709381609477599338578655387532371900097178971847542917138527769234958202457882528134933256542358099959040092642431289616883484407802808437261580615588792728203023632033804183543183050401055289424329308461203504966216490725561036203691386295145114674243802422808364579128274270941346210286772210587177299277977883532599697006743552002217337955540348328170764733918712963757441931526296401952476040703009622050369085914783996144391565741008894256923023992272660232264961932189878646406108546948610335453631561896555413192851737045739339824516375769435574694263069382153722514338332593620104660271464260589468584206027977801511954998796131843117868043168681128124758090158604640894123281980294821360324115442673821383034908215523732268842281671646490643299246370521810517903056957031222104717175386916099185926207215561072271017792075928852170334216128664324017414630572853193963697609619868061198660152744561750915731365220342144916168702701920511007890420121860254080657521012172846054489071897226316349579394033901505763980687868784826088812518907613700072380841628332327104280945151712837962786680426896298234226736623809910767747522997718381199434393500032745123060037453265409053604279052156685759629901902408699556927983425367623015085205610643136821779854395874984183701066472895208627290752346814760477631785287488872527074680158983327840912996989301213151354921784065828880417484121963917821897551225956917014529273549523432701672079346133417177887481558435487131297058783232125243012387449172389487595528166219793261627403733374232297874587897411266560060847189266215008624719737133453247913339072061513772458044054991058280599378915715633382466053818430542920030567500718013979560461159422150264127074249842222859293677614188340206544724160098267188542614889056088345578755677927933319004124033672044344644430660916445729206463068978375749104172289405138431223114211084742657051862433175143749371869698547935691112691467179550435198202966085559708177292967640754139108756081269538166816750323989077881134277302720729798860045526634264827746821219910524980166712917941160200877827112181645886502446709882876865069413296751132189039282390915846345489833791823965240963796879533805916814012776571432758428709730465444140674267204563523542535395945580678811677485288193553591546725016595277880292746026087760467291460067291573016121982625937759960180896322447144024535799231457389862641047139834226498036845509121198594870200412522638504777074561211358142741513339192286628544664646398935493188102907769481433644373244486298646082719341289303163859138490871500116435922949792407451554071724760867295437624424954810424696105512732491009579004739473932132541103148710442422268623143982520125419963328492701$
Condition satisfied: True

Constructing lattice basis...

Initial Lattice Matrix:

Lattice Matrix Overview: $9$ x $9$

```
Matrix Structure (X=non-zero, 0=zero):
00 X 0 0 0 0 0 0 0 0 ~
01 0 X 0 0 0 0 0 0 0 ~
02 0 0 X 0 0 0 0 0 0 ~
03 X X X X 0 0 0 0 0 
04 0 X X X X 0 0 0 0 
05 0 0 X X X X 0 0 0 
06 X X X X X X X 0 0 
07 0 X X X X X X X 0 
08 0 0 X X X X X X X 
```


Applying LLL reduction...

Constructing polynomial from first LLL vector...

Potential roots found: ($448479597905287366562801337296132819016115865214099082453373$, $2$)

Found K: $448479597905287366562801337296132819016115865214099082453373$

Recovered flag: `GrizzCTF{Graham_Cracked!}`

Time taken: 0.14 seconds

## References

- [David Wong - RSA and LLL Attacks](https://github.com/mimoo/RSA-and-LLL-attacks)
  - [YouTube Explanation](https://www.youtube.com/watch?v=3cicTG3zeVQ)
- [20 Years of Attacks on RSA Cryptosystem](https://www.ams.org/notices/199902/boneh.pdf)

